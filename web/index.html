<link rel="stylesheet" href="https://files.stork-search.net/basic.css" />


    <div class="container">
<label for="progress-bar" id="progress-label"> Download progress: </label>
<progress id="progress-bar" value="0" min="0" max="100"></progress>
</div>


<input id="searchterm" data-stork="foo" style="display:none" />
<div data-stork="foo-output"></div>
<script src="https://files.stork-search.net/stork.js"></script>
<script>
function http(rootUrl) {
  let loading = false;

  let chunks = [];
  let results = null;
  let error = null;

  let controller = null;

  const json = async (path, options,) => {
    _resetLocals();
    let signal = controller.signal;
    loading = true

    try {
      const response = await fetch(rootUrl + path, { signal, ...options });

      if (response.status >= 200 && response.status < 300) {
        results = await _readBody(response)
        return JSON.parse(results)
      } else {
        throw new Error(response.statusText)
      }
    } catch (err) {
      error = err
      results = null
      return error
    } finally {
      loading = false
    }
  }

  const _readBody = async (response) => {
    const reader = response.body.getReader();
    const length = +response.headers.get('content-length');
    let received = 0;

    while (loading) {
      const { done, value } = await reader.read();
      const payload = { detail: { received, length, loading } }
      const onProgress = new CustomEvent('fetch-progress', payload);
      const onFinished = new CustomEvent('fetch-finished', payload)

      if (done) {
        loading = false;
        window.dispatchEvent(onFinished)
      } else {
        chunks.push(value);
        received += value.length;
        window.dispatchEvent(onProgress)
      }
    }

    let body = new Uint8Array(received);
    let position = 0;

    for (let chunk of chunks) {
      body.set(chunk, position);
      position += chunk.length;
    }

    return new TextDecoder('utf-8').decode(body);
  }

  const _resetLocals = () => {
    loading = false;

    chunks = [];
    results = null;
    error = null;

    controller = new AbortController();
  }

  const cancel = () => {
    _resetLocals();
    controller.abort();
  };

  return { json, cancel }
}

const progressbar = document.getElementById('progress-bar');
const progressbutton = document.getElementById('fetch-button');
const abortbutton = document.getElementById('abort-button');
const progresslabel = document.getElementById('progress-label');

const { json } = http('index.st');
json('')

const setProgressbarValue = (payload) => {
    const { received, length, loading } = payload;
    const value = ((received / length) * 100).toFixed(2);
    progresslabel.textContent = `Download progress: ${value}%`;
    progressbar.value = value;
};


window.addEventListener('fetch-progress', (e) => {
    setProgressbarValue(e.detail);
});

window.addEventListener('fetch-finished', (e) => {
setProgressbarValue(e.detail);
    stork.register("foo", "./index.st", {showProgress: false})
        .then(() => document.getElementById('searchterm').style.display='block')
});

    </script>
